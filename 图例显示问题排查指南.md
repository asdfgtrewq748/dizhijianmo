# 图例显示问题排查指南

## 问题现象

图例（Legend）没有正确显示在3D视图中。

---

## 已修复的问题

### 1. 剖面切割模式下图例丢失 ✅

**问题原因：**
- `legend_entries` 变量定义在 `else` 分支中
- 启用剖面切割时，该变量未定义
- 导致后续添加图例时失败

**修复方法：**
- 将 `legend_entries = []` 移到 if/else 之前
- 在剖面切割分支也添加图例条目
- 确保两种模式都能生成图例

**修复位置：** [app_qt.py:1488](app_qt.py#L1488) 和 [app_qt.py:1510](app_qt.py#L1510)

---

## 可能的其他原因

### 2. PyVista 图例格式问题

**症状：**
- 控制台显示图例相关错误
- 或者图例显示为空白

**可能原因：**
- 颜色格式不正确（应该是 RGB 0-1 范围的元组）
- 图层名称包含特殊字符
- PyVista 版本兼容性问题

**解决方案：**

已添加错误处理和自动格式转换：
```python
# 1. 捕获异常并记录到日志
try:
    self.plotter.add_legend(legend_entries, ...)
except Exception as e:
    self.log(f"⚠️ 图例显示失败: {str(e)}")
    # 尝试简化格式
    ...

# 2. 自动转换颜色格式
if max(r, g, b) > 1.0:
    color = (r/255.0, g/255.0, b/255.0)

# 3. 确保名称为字符串
simplified_entries.append((str(name), color))
```

### 3. 没有可见的地层

**症状：**
- 控制台显示 "⚠️ 没有图例条目可显示"

**原因：**
- 所有地层都被取消勾选
- 或者渲染模式问题导致没有生成图例条目

**解决方案：**
1. 检查左侧"显示地层"列表
2. 确保至少勾选1个地层
3. 刷新渲染

### 4. 图例被遮挡

**症状：**
- 图例实际已生成，但不可见

**可能原因：**
- 图例位置被其他元素遮挡
- 背景色与图例色相近
- 图例太小或透明度过高

**解决方案：**

尝试修改图例位置：
```python
# 在 app_qt.py 中找到 add_legend 调用
self.plotter.add_legend(
    legend_entries,
    bcolor=(0.15, 0.15, 0.2),  # 背景色
    border=True,
    loc='lower right'  # 尝试改为 'upper right', 'lower left' 等
)
```

可用位置：
- `'upper right'` - 右上角
- `'upper left'` - 左上角
- `'lower left'` - 左下角
- `'lower right'` - 右下角（默认）
- `'center'` - 中央

---

## 排查步骤

### 步骤 1：检查日志

运行程序后，查看右侧控制台日志：

```
✓ 正常：没有任何图例相关的错误或警告

⚠️ 警告："没有图例条目可显示"
   → 说明没有勾选的地层，去勾选地层

⚠️ 警告："图例显示失败: xxx"
   → 说明格式问题，查看具体错误信息

✗ 错误："图例显示完全失败: xxx"
   → PyVista版本问题或严重的格式错误
```

### 步骤 2：验证地层状态

1. 在左侧"渲染控制"面板
2. 查看"显示地层"列表
3. 确认至少有1个地层被勾选（有✓标记）

### 步骤 3：检查渲染模式

1. 在"渲染模式"下拉框中
2. 尝试切换不同的模式：
   - 基础渲染
   - 增强材质
   - 真实纹理
   - 线框模式

3. 某些模式下图例可能更明显

### 步骤 4：检查剖面切割

如果启用了"启用剖面切割"：
1. 尝试关闭剖面切割
2. 查看图例是否显示
3. 如果显示了，说明是剖面模式的问题（应该已修复）

### 步骤 5：手动刷新

1. 点击左侧"渲染控制"面板的 **"🔄 刷新渲染"** 按钮
2. 或使用菜单栏：**视图 → 刷新渲染 (Ctrl+R)**

---

## 测试图例功能

### 测试用例 1：基本显示

```
前提：已构建三维模型

步骤：
1. 确保至少勾选2个地层
2. 不启用剖面切割
3. 渲染模式选择"基础渲染"
4. 查看右下角是否显示图例

预期结果：
- 右下角显示黑色半透明背景的图例
- 列出所有勾选地层的名称和颜色
```

### 测试用例 2：剖面切割模式

```
步骤：
1. 勾选2-3个地层
2. 启用"启用剖面切割"
3. 选择切割方向（如X轴）
4. 查看右下角图例

预期结果：
- 图例仍然显示
- 显示被切割后可见的地层
```

### 测试用例 3：动态更新

```
步骤：
1. 初始勾选3个地层
2. 确认图例显示3项
3. 取消勾选1个地层
4. 图例应自动更新为2项

预期结果：
- 图例实时更新
- 只显示当前勾选的地层
```

---

## 代码修改位置总结

如果需要自定义图例样式，修改以下位置：

### 1. 主渲染函数中的图例
**位置：** [app_qt.py:1660-1689](app_qt.py#L1660-L1689)

```python
if legend_entries:
    try:
        self.plotter.add_legend(
            legend_entries,
            bcolor=(0.15, 0.15, 0.2),  # 背景色 RGB
            border=True,                # 是否显示边框
            loc='lower right'           # 位置
        )
    except Exception as e:
        # 错误处理
        ...
```

### 2. 图层可见性更新中的图例
**位置：** [app_qt.py:1870-1886](app_qt.py#L1870-L1886)

```python
# 更新图例
self.plotter.remove_legend()  # 先移除旧图例
if legend_entries:
    try:
        self.plotter.add_legend(...)
    except:
        # 错误处理
        ...
```

---

## 高级自定义

### 自定义图例样式

如果想修改图例外观，可以调整这些参数：

```python
self.plotter.add_legend(
    legend_entries,
    bcolor=(0.2, 0.2, 0.3),      # 背景色 (R, G, B) 0-1
    border=True,                  # 显示边框
    loc='lower right',            # 位置
    size=(0.15, 0.15),           # 大小 (宽度, 高度) 相对于窗口
    face='rectangle',             # 形状: 'rectangle' 或 'circle'
    font_size=14,                 # 字体大小
)
```

### 完全自定义图例

如果 PyVista 的图例功能不满足需求，可以使用 VTK 原生方法：

```python
# 创建自定义图例
import vtk

legend = vtk.vtkLegendBoxActor()
legend.SetNumberOfEntries(len(legend_entries))

for i, (name, color) in enumerate(legend_entries):
    legend.SetEntry(i, vtk.vtkPolyData(), name, color)

legend.GetPositionCoordinate().SetCoordinateSystemToNormalizedViewport()
legend.GetPositionCoordinate().SetValue(0.7, 0.1)
legend.SetWidth(0.25)
legend.SetHeight(0.3)

self.plotter.renderer.AddActor(legend)
```

---

## 已知问题

### PyVista 版本兼容性

某些 PyVista 版本的 `add_legend` 参数可能略有不同：

**PyVista < 0.40:**
```python
# 旧版本可能不支持 border 参数
self.plotter.add_legend(legend_entries, bcolor='gray', loc='lower right')
```

**PyVista >= 0.40:**
```python
# 新版本支持更多参数
self.plotter.add_legend(
    legend_entries,
    bcolor=(0.15, 0.15, 0.2),
    border=True,
    loc='lower right'
)
```

**检查版本：**
```python
import pyvista as pv
print(pv.__version__)
```

---

## 常见问题 FAQ

### Q1: 图例显示但颜色不对

**A:** 检查 `RockMaterial.get_color()` 返回的颜色值
- 应该是 (R, G, B) 元组
- 值范围应该是 0.0-1.0
- 如果是 0-255，会被自动转换

### Q2: 图例显示乱码

**A:** 地层名称包含特殊字符
- 确保名称是有效的 UTF-8 字符串
- 避免使用过长的名称（建议<20字符）

### Q3: 图例太小看不清

**A:** 调整字体大小或图例尺寸
```python
self.plotter.add_legend(
    legend_entries,
    ...,
    size=(0.2, 0.3),  # 增大尺寸
    font_size=16       # 增大字体
)
```

### Q4: 图例与其他元素重叠

**A:** 改变图例位置
```python
loc='upper right'  # 改到右上角
# 或
loc='lower left'   # 改到左下角
```

---

## 调试技巧

### 1. 打印图例条目

在 `render_3d_model()` 函数中添加调试信息：

```python
# 在 "添加图例" 之前
print(f"图例条目数量: {len(legend_entries)}")
for name, color in legend_entries:
    print(f"  {name}: {color}")
```

### 2. 测试最小示例

创建简单的测试脚本：

```python
import pyvista as pv

plotter = pv.Plotter()

# 创建简单网格
sphere = pv.Sphere()
plotter.add_mesh(sphere, color='red', label='测试球体')

# 添加图例
plotter.add_legend([('测试球体', (1.0, 0.0, 0.0))], loc='lower right')

plotter.show()
```

如果这个都不显示，说明是 PyVista 安装或配置问题。

---

## 总结

图例显示问题主要原因：
1. ✅ **已修复**：剖面切割模式下 `legend_entries` 未定义
2. ✅ **已优化**：添加了错误处理和格式转换
3. ⚠️ **需检查**：确保至少勾选1个地层
4. ⚠️ **需检查**：PyVista 版本兼容性

如果问题仍未解决，请：
1. 查看控制台日志中的具体错误信息
2. 检查 PyVista 版本 (`pip show pyvista`)
3. 尝试升级 PyVista (`pip install --upgrade pyvista`)
4. 提供错误截图和日志信息以便进一步诊断

---

**更新日期：** 2025-12-18
**版本：** v1.0
