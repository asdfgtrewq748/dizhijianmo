# 启动指南

本文档详细说明如何启动和使用GNN三维地质建模系统。

**推荐使用PyQt6桌面应用获得最佳性能！** ⭐

---

## 目录

1. [PyQt6桌面应用（推荐）](#1-pyqt6桌面应用推荐)
2. [命令行工具](#2-命令行工具)
3. [Streamlit Web界面（备选）](#3-streamlit-web界面备选)
4. [数据准备](#4-数据准备)
5. [常见问题](#5-常见问题)

---

## 1. PyQt6桌面应用（推荐）

### 1.1 为什么选择PyQt6版本？

**性能对比**：
| 指标 | Streamlit | PyQt6 | 提升倍数 |
|------|----------|-------|---------|
| 建模速度 | 8-15秒 | 1-2秒 | **5-10倍** |
| 渲染帧率 | 5-15 FPS | 60+ FPS | **4-12倍** |
| GPU利用率 | 10-20% | 70-90% | **4-8倍** |
| UI响应性 | 阻塞 | 流畅 | **质的飞跃** |

### 1.2 安装PyQt6环境

```bash
# 创建虚拟环境
conda create -n geomodel python=3.10 -y
conda activate geomodel

# 安装PyTorch (CUDA 12.1)
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121

# 安装PyTorch Geometric
pip install torch-geometric

# 安装PyQt6依赖（一键安装）
install_qt.bat
```

**手动安装PyQt6依赖**：
```bash
pip install PyQt6==6.6.1
pip install pyvistaqt==0.11.0
pip install pyvista>=0.43.0
```

### 1.3 启动PyQt6应用

```bash
# 方式1：直接运行（推荐）
python app_qt.py

# 方式2：使用启动脚本
run_qt.bat

# 方式3：双击 run_qt.bat 文件
```

### 1.4 PyQt6界面使用指南

#### 界面布局

```
┌──────────────┬──────────────┬─────────────────────┐
│  控制面板    │  信息面板    │   3D渲染区域         │
│  (左侧)      │  (中间)      │   (右侧)            │
├──────────────┼──────────────┼─────────────────────┤
│ 数据配置     │ 统计信息      │                     │
│ 预测方法     │ 进度条       │    PyVista          │
│ 建模配置     │ 控制台日志    │    GPU渲染窗口       │
│ 渲染控制     │              │                     │
│ 导出按钮     │              │                     │
└──────────────┴──────────────┴─────────────────────┘
```

#### 工作流程

**步骤1：加载数据**
1. 配置数据选项（煤层合并、K邻居数、层序方法等）
2. 点击"🔄 加载数据"按钮
3. 等待后台线程加载完成
4. 查看统计信息面板

**步骤2：训练模型**
1. 选择预测方法：
   - **传统方法**：IDW/Kriging/Hybrid插值
   - **GNN深度学习**：图神经网络（性能更优）
2. 配置训练参数
3. 点击"🚀 开始训练"
4. 观察进度条和日志

**步骤3：构建三维模型**
1. 设置网格分辨率（20-200）
2. 设置基准面高程
3. 点击"🏗️ 构建三维模型"
4. 等待建模完成

**步骤4：渲染控制**
- **层选择**：在列表中选择要显示的地层（Ctrl+点击多选）
- **渲染模式**：切换增强材质/基础渲染/线框模式
- **透明度**：拖动滑块实时调节（0.3-1.0）
- **侧面显示**：开关地层侧面（隐藏可提升50%性能）
- **钻孔标记**：显示钻孔位置和标签
- **刷新渲染**：手动刷新3D视图

**步骤5：导出模型**
- **PNG截图**：高清2X截图
- **HTML交互**：可在浏览器中交互的模型
- **OBJ模型**：通用3D格式
- **STL模型**：3D打印格式
- **VTK模型**：科学可视化格式

#### 3D交互操作

- **左键拖动**：旋转视角
- **右键拖动**：平移视角
- **滚轮**：缩放
- **双击**：重置视角

#### 性能优化技巧

1. **提升渲染性能**：
   - 隐藏侧面可提升50%性能
   - 使用线框模式最快
   - 只选择需要查看的地层

2. **大规模数据处理**：
   - 50×50网格：实时流畅
   - 100×100网格：流畅
   - 200×200网格：可用

### 1.5 验证安装

```bash
python -c "import PyQt6; print('PyQt6 版本:', PyQt6.QtCore.PYQT_VERSION_STR)"
python -c "import pyvista; print('PyVista 版本:', pyvista.__version__)"
python -c "from pyvistaqt import QtInteractor; print('PyVistaQt 安装成功!')"
```

---

## 2. 命令行工具

**适合批量处理和脚本自动化**

### 2.1 安装环境

```bash
# 创建虚拟环境
conda create -n geomodel python=3.10 -y
conda activate geomodel

# 安装PyTorch (根据CUDA版本选择)
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# 安装PyTorch Geometric
pip install torch-geometric

# 安装其他依赖
pip install -r requirements.txt
```

### 2.2 查看帮助

```bash
python main_thickness.py --help
python main_thickness.py train --help
python main_thickness.py all --help
```

### 2.3 完整流程（推荐）

一键完成训练和建模：

```bash
# 激活环境
conda activate geomodel

# 运行完整流程
python main_thickness.py all --epochs 300 --resolution 50
```

### 2.4 分步执行

**步骤1：仅训练模型**

```bash
python main_thickness.py train --epochs 300 --output output
```

参数说明：
- `--epochs 300`：训练300轮
- `--lr 0.001`：学习率
- `--hidden-dim 128`：隐藏层维度
- `--gnn-layers 3`：GNN层数
- `--conv-type gatv2`：卷积类型（gatv2/transformer/sage）
- `--patience 30`：早停耐心值

**步骤2：构建三维模型**

```bash
python main_thickness.py build --model-path output/best_model.pt --resolution 50
```

参数说明：
- `--model-path`：训练好的模型路径
- `--resolution 50`：网格分辨率（50x50）
- `--base-level 0.0`：基准面高程
- `--gap 0.0`：层间间隙

### 2.5 传统方法对比

运行传统插值方法作为基准对比：

```bash
# 线性插值
python main_thickness.py baseline --method linear

# 三次插值
python main_thickness.py baseline --method cubic

# RBF插值
python main_thickness.py baseline --method rbf
```

---

## 3. Streamlit Web界面（备选）

**适合远程访问和演示展示**

**注意**：Streamlit版本存在性能限制，建模速度较慢，GPU利用率低（10-20%），界面操作会阻塞UI。强烈建议使用PyQt6版本获得最佳性能。

### 3.1 启动Streamlit应用

```bash
# 激活环境
conda activate geomodel

# 启动Web界面
streamlit run app.py
```

### 3.2 访问界面

启动后，在浏览器打开：
- 本地访问：http://localhost:8501
- 局域网访问：http://<你的IP>:8501

### 3.3 指定端口启动

```bash
# 使用指定端口
streamlit run app.py --server.port 8080

# 允许外部访问
streamlit run app.py --server.address 0.0.0.0
```

---

## 4. 数据准备

### 4.1 数据目录结构

将钻孔数据放入 `data/` 目录：

```
data/
├── 钻孔坐标.csv          # 坐标文件（必需，文件名包含"坐标"）
├── ZK001.csv            # 钻孔1数据
├── ZK002.csv            # 钻孔2数据
├── ZK003.csv            # 钻孔3数据
└── ...                  # 更多钻孔
```

### 4.2 坐标文件格式

文件名必须包含"坐标"二字（如 `钻孔坐标.csv`）：

```csv
钻孔名,坐标x,坐标y
ZK001,39645876.2,4438976.5
ZK002,39646120.8,4439102.3
ZK003,39645500.0,4439000.0
```

### 4.3 钻孔数据文件格式

每个钻孔一个CSV文件，文件名即钻孔名（如 `ZK001.csv`）：

```csv
序号,名称,厚度/m,弹性模量/GPa,容重/kN·m-3,抗拉强度/MPa
1,腐殖土,2.5,,,
2,砂岩,5.2,15.3,25.6,3.8
3,泥岩,3.1,8.4,23.2,1.2
4,煤,1.8,3.5,14.0,0.5
5,砂岩,4.5,16.2,25.8,4.0
```

**必需列**：
- `名称` 或 `岩性`：岩层名称
- `厚度/m` 或 `厚度`：岩层厚度

**可选列**：
- `序号`：层序号
- `弹性模量`、`容重`、`抗拉强度`：岩层属性

---

## 5. 常见问题

### Q1: PyQt6导入失败

**现象**：`ModuleNotFoundError: No module named 'PyQt6'`

**解决方案**：
```bash
# 安装PyQt6和依赖
pip install PyQt6==6.6.1
pip install pyvistaqt==0.11.0
pip install pyvista>=0.43.0

# 或使用一键脚本
install_qt.bat
```

### Q2: CUDA内存不足

**现象**：`CUDA out of memory`

**解决方案**：
```bash
# 减小batch size或隐藏层维度
python main_thickness.py train --hidden-dim 64 --epochs 200

# 或使用CPU
python main_thickness.py train --device cpu
```

### Q3: 找不到坐标文件

**现象**：`FileNotFoundError: 未找到坐标文件`

**解决方案**：
- 确保坐标文件名包含"坐标"二字
- 检查文件是否在 `data/` 目录下

### Q4: 编码错误

**现象**：`UnicodeDecodeError`

**解决方案**：
- 将CSV文件另存为 UTF-8 编码
- 或使用 GBK 编码保存

### Q5: PyVista渲染失败

**现象**：PyQt6界面中3D渲染区域空白

**解决方案**：
```bash
# 确保安装了PyVistaQt
pip install pyvistaqt==0.11.0

# 更新PyVista到最新版
pip install --upgrade pyvista
```

### Q6: 模块导入失败

**现象**：`ModuleNotFoundError`

**解决方案**：
```bash
# 确保在项目根目录运行
cd D:\xiangmu\dizhijianmo

# 确保激活了正确的环境
conda activate geomodel
```

### Q7: 训练不收敛

**现象**：损失不下降或波动大

**解决方案**：
```bash
# 降低学习率
python main_thickness.py train --lr 0.0005

# 增加训练轮数
python main_thickness.py train --epochs 500 --patience 50
```

### Q8: PyQt6界面卡顿

**现象**：界面响应慢或卡顿

**解决方案**：
- 降低网格分辨率（20-50）
- 隐藏侧面显示
- 使用线框渲染模式
- 只选择部分地层显示

---

## 快速启动命令汇总

### PyQt6版本（推荐）⭐
```bash
# 1. 激活环境
conda activate geomodel

# 2. 进入项目目录
cd D:\xiangmu\dizhijianmo

# 3. 启动PyQt6应用
python app_qt.py

# 或使用快速启动脚本
run_qt.bat
```

### 命令行版本
```bash
# 1. 激活环境
conda activate geomodel

# 2. 进入项目目录
cd D:\xiangmu\dizhijianmo

# 3. 运行完整流程
python main_thickness.py all --epochs 300

# 4. 启动可视化（可选）
streamlit run app.py
```

---

## 相关文档

- [README.md](README.md) - 项目总览
- [PYQT_FEATURES.md](PYQT_FEATURES.md) - PyQt6详细功能说明
- [PYQT_RESTORE_COMPLETE.md](PYQT_RESTORE_COMPLETE.md) - PyQt6恢复完成摘要

---

## 联系与支持

如有问题，请检查：
1. 数据格式是否正确
2. 环境依赖是否完整
3. 查看控制台日志输出
4. 参考常见问题章节
