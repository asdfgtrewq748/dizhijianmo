## 优化建议（可执行清单）

### 优先级概览
- P0：FLAC3D导出自动材料/边界/质量报告；小样本自动切换传统方法；基准面自动计算
- P1：Kriging变差函数自动拟合；GNN地质约束损失；导出网格质量修复
- P2：集成预测(传统+GNN)；四面体导出自适应细分；交叉验证评估框架

### FLAC3D耦合优化
1) 自动材料属性设置（按岩性映射）
- 做什么：在 EnhancedFLAC3DExporter 导出时自动写入 density/bulk/shear/cohesion/friction 等。
- 怎么做：
	- 在 src/exporters/flac3d_enhanced_exporter.py 增加 ROCK_PROPERTIES 字典（Coal/Mudstone/Sandstone/Limestone 等默认值）。
	- 在导出末尾追加命令：`zone property dens=... bulk=... shear=... cohesion=... friction=... range group '岩性组名'`。
	- 中文岩性先映射英文（已有），缺失值使用保守默认参数并记录日志。

2) 网格质量检查与报告
- 做什么：导出前检查并输出网格质量（负体积、Jacobian、纵横比、扭曲度），给出统计与示警。
- 怎么做：
	- 构造单元时计算体积/行列式；负体积单元记录到列表。
	- 统计：总单元数、负体积比例、max/min 纵横比、扭曲度分位数；写入日志并在导出文件旁生成 `*_quality_report.txt`。
	- 如果负体积>0：尝试微调节点（小幅扰动）重算，失败则标记需人工检查。

3) 坐标系与精度
- 做什么：避免大坐标导致节点合并或精度损失。
- 怎么做：
	- 自动检测坐标范围，若跨度>1e5，使用局部坐标系（减去原点偏移），在导出文件头写明 offset。
	- coord_precision 从 6 提高到 8，可配置；节点 key 使用 round(x, precision)。

4) 分组与效率
- 做什么：减少大型模型的命令行长度与解析成本。
- 怎么做：
	- zone group 写入改为 range id list 分批；同时提供 f3grid 原生导出选项（优先推荐）。
	- 对六面体导出添加可选四面体分解（已有 TetraF3GridExporter），在 UI/CLI 暴露开关。

5) 边界与工况占位
- 做什么：导出后能直接在 FLAC3D 里快速上载工况。
- 怎么做：
	- 生成示例命令片段附在导出文件尾或旁文件：顶部自由、底部固定、侧向滚动边界；重力加载；可留 TODO 供用户替换。

### 建模算法优化
1) 小样本智能切换
- 做什么：样本量不足时自动用传统方法，避免 GNN 欠拟合。
- 怎么做：
	- 在训练前根据钻孔数选择：<5 constant，中间 IDW，<50 Kriging，>=50 GNN。
	- UI 上提示当前选择及原因，允许手动覆盖。

2) GNN 地质约束损失
- 做什么：让厚度预测符合地质规律（层间平滑、非负、存在性耦合）。
- 怎么做：
	- 在厚度损失中增加：相邻层厚度差平滑项；负厚度惩罚；存在性概率对厚度加权。
	- 存在性头与厚度头共享 logits，厚度 = softplus(head) * exist_prob。

3) Kriging 变差函数自动拟合
- 做什么：根据数据自动选择 spherical/exponential/gaussian/linear。
- 怎么做：
	- 对每个候选模型做简易交叉验证（留一或 k-fold），选择误差最小者。
	- 暴露到 TraditionalPredictor，记录所选模型和得分。

4) 集成预测（提升稳健性）
- 做什么：融合 GNN、IDW、Kriging 多模型，降低单模型偏差。
- 怎么做：
	- 训练/拟合各自模型，基于验证误差计算自适应权重；推理时加权平均。
	- 小样本时权重偏向传统法；样本充足时适度放大 GNN 权重。

5) 基准面与厚度下限
- 做什么：避免模型悬空或层间穿插。
- 怎么做：
	- base_level 自动取数据最小 z（或用户输入）；UI 增加“自动基准面”按钮。
	- min_thickness 按岩性/层类型可配置（薄煤层用更小阈值），避免统一 0.5m 导致过厚。

6) 数据增强与归一化
- 做什么：提高小样本泛化并避免大坐标数值不稳定。
- 怎么做：
	- 在 layer_modeling/thickness 处理链中加入高斯扰动/随机平移增强（可选开关）。
	- 训练前对坐标做零均值单位方差或局部坐标系平移，推理时再平移回去。

### 数据与流程
- 清洗：确保钻孔必备字段 x,y,z,lithology；编码自动探测已支持，建议在导入前统一 UTF-8。
- 质量规则：钻孔<3 不训练；缺失厚度用 IDW 填补；稀有层(<2 孔)标记并在报告中提示不稳定。
- 模型输出：训练/推理后写出验证指标、层序、存在率、厚度分布；生成一页 PDF/MD 报告便于审阅。

### 评估与交付
- 测试：新增集成测试用例覆盖 FLAC3D 导出（几何一致性、节点共享、质量报告生成）。
- 基准：保存一组小样本/中样本基准数据，跑一键 benchmark，输出误差对比与耗时。
- 文档：更新 FLAC3D_EXPORT_GUIDE.md，补充材料属性、坐标偏移、质量报告说明和常见报错处理。

### 落地顺序（建议）
1) P0：材料属性自动写入 + 基准面自动计算 + 小样本自动切换
2) P0：网格质量检查与报告（含负体积修复尝试）
3) P1：Kriging 变差函数自动拟合 + GNN 地质约束损失
4) P2：集成预测 + 四面体自适应细分 + 交叉验证/benchmark 套件
