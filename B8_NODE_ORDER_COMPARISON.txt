╔════════════════════════════════════════════════════════════════════════════╗
║                   FLAC3D B8 单元节点顺序对比                                 ║
╚════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────┐
│ ❌ 错误的旧顺序（已修复）                                                   │
│ "先底面4个，后顶面4个" - 不符合FLAC3D标准                                   │
└──────────────────────────────────────────────────────────────────────────┘

    索引:  0        1        2        3        4        5        6        7
    节点:  SW_bot   SE_bot   NE_bot   NW_bot   SW_top   SE_top   NE_top   NW_top
           ↓        ↓        ↓        ↓        ↓        ↓        ↓        ↓
           1        2        5        3        4        7        8        6
           (底面4个节点)              (顶面4个节点)

    问题：这种分组会导致FLAC3D内部四面体分解时出现负体积！


┌──────────────────────────────────────────────────────────────────────────┐
│ ✅ 正确的新顺序（FLAC3D官方标准）                                            │
│ "交织模式" - 符合官方文档 "Orientation of Nodes and Faces within a Zone"  │
└──────────────────────────────────────────────────────────────────────────┘

    索引:  0        1        2        3        4        5        6        7
    节点:  SW_bot   SE_bot   NW_bot   SW_top   NE_bot   NW_top   SE_top   NE_top
           ↓        ↓        ↓        ↓        ↓        ↓        ↓        ↓
           1        2        3        4        5        6        7        8
           (底)     (底)     (底)     (顶)     (底)     (顶)     (顶)     (顶)

    特点：底面和顶面节点交织排列，形成特定的连接模式


╔════════════════════════════════════════════════════════════════════════════╗
║                            三维可视化对比                                    ║
╚════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────── 从上往下看（顶视图）────────────────────────┐
│                                                                    │
│        NW ●───────────● NE          y (北)                         │
│           │           │             ↑                              │
│           │           │             │                              │
│           │           │             │                              │
│        SW ●───────────● SE          └────→ x (东)                  │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

┌─────────────────────── 节点编号映射 ──────────────────────────────┐
│                                                                    │
│  底面 (z 较小):              顶面 (z 较大):                          │
│                                                                    │
│     3:NW ●─────────● 5:NE        6:NW ●─────────● 8:NE            │
│          │         │                  │         │                 │
│          │         │                  │         │                 │
│     1:SW ●─────────● 2:SE        4:SW ●─────────● 7:SE            │
│                                                                    │
│  垂直对应关系:                                                       │
│  1(SW_bot) ↔ 4(SW_top)                                            │
│  2(SE_bot) ↔ 7(SE_top)                                            │
│  3(NW_bot) ↔ 6(NW_top)                                            │
│  5(NE_bot) ↔ 8(NE_top)                                            │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘


╔════════════════════════════════════════════════════════════════════════════╗
║                       顺序变化详细对比表                                     ║
╚════════════════════════════════════════════════════════════════════════════╝

┌─────────┬──────────────┬──────────────┬──────────────┬─────────────┐
│ 索引位置 │ 旧顺序（错误） │ FLAC3D编号   │ 新顺序（正确） │ FLAC3D编号  │
├─────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│    0    │   gp_b_00    │      1       │   gp_b_00    │      1      │
│         │   (SW_bot)   │              │   (SW_bot)   │             │
├─────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│    1    │   gp_b_10    │      2       │   gp_b_10    │      2      │
│         │   (SE_bot)   │              │   (SE_bot)   │             │
├─────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│    2    │   gp_b_11    │      5       │   gp_b_01    │      3      │
│         │   (NE_bot)   │   ← 错误!    │   (NW_bot)   │  ← 修正!    │
├─────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│    3    │   gp_b_01    │      3       │   gp_t_00    │      4      │
│         │   (NW_bot)   │   ← 错误!    │   (SW_top)   │  ← 修正!    │
├─────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│    4    │   gp_t_00    │      4       │   gp_b_11    │      5      │
│         │   (SW_top)   │              │   (NE_bot)   │  ← 修正!    │
├─────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│    5    │   gp_t_10    │      7       │   gp_t_01    │      6      │
│         │   (SE_top)   │   ← 错误!    │   (NW_top)   │  ← 修正!    │
├─────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│    6    │   gp_t_11    │      8       │   gp_t_10    │      7      │
│         │   (NE_top)   │              │   (SE_top)   │  ← 修正!    │
├─────────┼──────────────┼──────────────┼──────────────┼─────────────┤
│    7    │   gp_t_01    │      6       │   gp_t_11    │      8      │
│         │   (NW_top)   │              │   (NE_top)   │             │
└─────────┴──────────────┴──────────────┴──────────────┴─────────────┘


╔════════════════════════════════════════════════════════════════════════════╗
║                    为什么交织模式是正确的？                                   ║
╚════════════════════════════════════════════════════════════════════════════╝

FLAC3D 内部会将每个 B8 六面体分解为 5 个四面体进行几何检查：

标准分解方案（基于正确的节点顺序）:
  四面体 1: (1, 2, 3, 4)  = (SW_bot, SE_bot, NW_bot, SW_top)
  四面体 2: (2, 5, 3, 8)  = (SE_bot, NE_bot, NW_bot, NE_top)
  四面体 3: (2, 3, 4, 8)  = (SE_bot, NW_bot, SW_top, NE_top)
  四面体 4: (2, 4, 7, 8)  = (SE_bot, SW_top, SE_top, NE_top)
  四面体 5: (3, 4, 8, 6)  = (NW_bot, SW_top, NE_top, NW_top)

如果节点顺序错误，这些四面体的体积计算会出错：
  ❌ 负体积 → 四面体翻转
  ❌ 零体积 → 四面体退化（4个点共面）

结果：FLAC3D 拒绝导入，报错 "Zone X has a negative volume"


╔════════════════════════════════════════════════════════════════════════════╗
║                         修复前后对比                                         ║
╚════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────┐
│ 修复前                                                                    │
├─────────────────────────────────────────────────────────────────────────┤
│ ❌ Zone 1 has a negative volume                                         │
│ ❌ Zone 1 geometry can only support one overlay (tet volumes <= 0)      │
│ ❌ Zone 195 has a negative volume                                       │
│ ❌ 大量单元导入失败                                                        │
│ ❌ 模型几何混乱、层间穿插                                                   │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 修复后（预期）                                                             │
├─────────────────────────────────────────────────────────────────────────┤
│ ✅ 所有单元成功导入                                                        │
│ ✅ 无负体积错误                                                            │
│ ✅ 无四面体退化警告                                                         │
│ ✅ 模型几何正确，层理清晰                                                    │
│ ✅ 可以正常进行力学计算                                                     │
└─────────────────────────────────────────────────────────────────────────┘


╔════════════════════════════════════════════════════════════════════════════╗
║                           验证清单                                           ║
╚════════════════════════════════════════════════════════════════════════════╝

□ 1. 语法检查：python -m py_compile src/exporters/f3grid_exporter_v2.py
     ✅ 已通过

□ 2. 重新导出模型：使用修复后的导出器

□ 3. FLAC3D 导入测试：
     zone import f3grid "geological_model.f3grid"

□ 4. 检查导入日志：
     - 无 "negative volume" 错误
     - 无 "tet volumes <= 0" 警告
     - 所有 zone 成功创建

□ 5. 质量检查：
     zone list information
     - 检查单元数量
     - 检查体积统计
     - 检查几何质量


╔════════════════════════════════════════════════════════════════════════════╗
║                           参考资料                                           ║
╚════════════════════════════════════════════════════════════════════════════╝

📚 FLAC3D 官方文档:
   https://docs.itascacg.com/flac3d/docproject/source/
   → Zone Geometry → Orientation of Nodes and Faces within a Zone

📄 优化建议:
   优化建议.md (第 64-73 行)

📄 修复文档:
   F3GRID_NODE_ORDER_FIX.md

🔧 修改文件:
   src/exporters/f3grid_exporter_v2.py
   - 第 556-569 行: gp_ids 顺序
   - 第 571-582 行: coords 坐标数组
   - 第 1-43 行: 文件头注释


═════════════════════════════════════════════════════════════════════════════
修复完成时间: 2025-12-21
修复版本: f3grid_exporter_v2.py (最终修正版)
修复作者: Claude Code
═════════════════════════════════════════════════════════════════════════════
